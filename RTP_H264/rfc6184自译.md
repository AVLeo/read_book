# RTP Payload Format for H264 Video
&emsp;&emsp;rtp如何承载h264视频报文(RFC6184自译精选)，主要针对自己开发中使用的封装、解封转的几种方式进行原文翻译。
## 5.2 Payload Structs(负载结构)
&emsp;&emsp;负载格式定义了3中不同的基础负载结构。接收者可以通过负载数据的第一个字节来确定该负载的结构类型。这个字节也用用来表示NAL单元类型。NAL单元类型字段定义本报文后面的负载数据的结构类型。下面介绍3种主要的结构类型:<br/>
* Single NAL Unit Packet: 该负载类型只包含一个NAL单元。NAL单元类型字段值范围为1到23。详情见5.6节
* Aggregation Packet: 该类型包含多个NAL单元到一个RTP负载中。本类型有4种版本: Single-Time Aggregation Packet Type A(STAP-A), Single-Time Aggregation Packet Type B(STAP-B), Multi-Time Aggregation Packet(MTAP) with 16-bit offset(MTAP16), 和Multi-Time Aggregation Packet(MTAP) with 24-bit offset(MTAP24)。STAP-A, STAP-B, MTAP16和MTAP24的NAL单元类型字段值分别是24，25，26和27。详情5.7。
* Fragementation unit: 改类型将一个NAL单元分片到多个RTP报文中。有两个版本: FUa, FUb, 类型只为28, 29。在5.8中详解。

&emsp;&emsp;Table 1总结了NAL单元类型和对应的RTP报文类型，同时其中一种NAL单元都成为RTP报文的载荷，类型值将作为备忘录记录。<br/>
![nal_unit_rtp_type](https://github.com/runner365/read_book/blob/master/RTP_H264/pic/Summary_NALU_type_and_packet_type.png)

## 5.3 NAl Unit Header Usage(NALU头用法)
&emsp;&emsp;NAL单元类型格式如下<br/>
![nal_unit_header type](https://github.com/runner365/read_book/blob/master/RTP_H264/pic/NALU_HEADER_TYPE.png)<br/>
&emsp;&emsp;其中字段F和NRI的语义如下:<br/>
* F: 1 bit, forbidden_zero_bit. <br/>
&emsp;&emsp;0代表NAL单元类型字段和其内容可能存在bit级别的错误或其他语义错误部分。1代表包含bit不存在bit级别的错误或其他语义错误部分。MANEs建议设置F位表明是否在NAL单元中有bit级别的错误。H264规范要求设置F为0。当F为1时，解码器就得知NAL单元中可能存在bit错误或其他语义错误。最简单的处理方法就是丢弃该负载，并且做错误补偿处理<br/>
* NRI: 2 bits, nal_ref_idc.<br/>
&emsp;&emsp;该字段的意义同H264规范要求没有什么不同。也就是说，00代表该NAL单元内容并不用来为I帧来重构参考帧，这样的帧即使被丢弃也不会影响到参考帧的完整性。该字段大于00时，代表这个NAL单元的界面会影响到参考帧的完整性。<br/>
&emsp;&emsp;除了上面的规定外，该字段对于RTP协议来说，也由编码器定义的RTP报文优先级。MANEs用该字段来更好的保护重要的NAL数据，相比不那么重要的NAL数据。最高级别是11，其次是10，后面是01，最后是00.<br/>
&emsp;&emsp;H264编码器必须根据H264规范设置NRI字段，基于NAL单元类型值1到12内。基于规范，当NAL单元类型为6，9，10，11或12，对NRI字段设置为0。<br/>
&emsp;&emsp;NAL单元类型值为7、8(也就是常说的sps,pps)， H264编码器应该设置NRI值为11。对于NAL单元类型为5(常说的IDR帧，也就是I帧)，NRI只也应该设置成11.<br/>
&emsp;&emsp;对于NAL单元类型到NRI值的映射，接下来的例子显示了在一定环境下的有效性。其他的映射关系也应该类似这样，必须基于应用场景和H264规范。</br>
![nal_type_to_nri_map](https://github.com/runner365/read_book/blob/master/RTP_H264/pic/nal_type_to_nri_map.png)<br/>
&emsp;&emsp;提示: 如上所示，非参考帧的类型，NRI值为00.<br/>
&emsp;&emsp;H264编码器应该设置NRI值为01，针对参考帧的coded sliced和coded slice data partition NAL单元。<br/>
&emsp;&emsp;针对NRI值的NAL类型值为24，29，将在备忘录的5.7和5.8节进行描述。<br/>
&emsp;&emsp;对于NAL单元type值13到23的对应NRI值是没有推荐值的，因为这些值是在ITU-T和ISO/IEC。对于NAL单元type值0和范围30到31，也是没有推荐值，这些值在备忘录中也是没有语义规定。<br/>
## 5.4 Packetization Modes(打包模型)
&emsp;&emsp;本节备忘录定义3种模型:<br/>
* single NAL unit mode(单NAL单元模式)
* non-interleaved mode(非间隔模式)
* interleaved mode(间隔模式)
&emsp;&emsp;single NAL unit mode是针对实时会话系统，符合ITU-T推荐H.241(见12.1). non-interleaved mode也是针对实时会话系统，但是不符合ITU-T推荐H.241。在non-interleaved mode中，很多NAL单元根据解码的顺序进行发送。interleaved mode是针对延时要求不高的系统，它允许NAL单元不基于解码顺序来发送。<br/>
&emsp;&emsp;打包模式类型通过媒体类型的参数来标识。打包模式确定RTP负载中的NAL单元类型。Table3总结了每个打包模式的负载类型。各种打包模式会在第6节详细介绍。<br/>
![packetization_type_summary](https://github.com/runner365/read_book/blob/master/RTP_H264/pic/Table3_packetization_mode.png)<br/>
&emsp;&emsp;一些NAL单元或负载类型值(在talbe3中是reserved的)是为未来保留的。这些类型的NAL单元类型不应该本发送者发送(不能作为RTP负载，如聚合单元在聚合报文中，或者分片单元在分片报文中)，这些报文肯定要被接受者直接丢弃。举例，负载类型1到23，是单NAL单元模式和非间隔模式，但绝对不能是间隔模式。然而，除了被直接用在报文负载内，NAL类型1~23也能被使用在间隔模式作为间隔单元，如STAP-B，MTAP16和MTAP24报文如FUa、FUb。同样的，1到23的NAL单元类型也能用STAP-A报文在非间隔模式中，或FUa报文在分片报文中。

## 5.5 Decoding Order Number (DON)
&emsp;&emsp;非节不翻译，主要原因还是工作中用不到，也就是interleaved mode(间隔模式)用不到，工作中用不到RTP针对延时要求不高的系统。个人也怀疑什么应用场景才会用到这样的乱序模式。

## 5.6 Single NAL Unit Packet (单NAL单元报文)
&emsp;&emsp;单NAL单元报文定义: 只包含一个NAL单元。也就是说聚合报文和分片报文都不能放在单NAL单元报文中。单NAL单元报文构造的时候，必须和RTP sequence的顺序是一致的。单NAL单元报文的结构格式如Figure2所示。<br/>
![single nal unit packet](https://github.com/runner365/read_book/blob/master/RTP_H264/pic/Single_NAL_Unit_Packet_Format.png)<br/>
&emsp;&emsp;信息提示: NAL单元第一个字节也是作为RTP负载的头。

## 5.7 Aggregation Packets (聚合报文)
&emsp;&emsp;聚合报文是一种负载定义的NAL单元聚合方案。这个方案主要用于适应不同网络MTU大小的情况: 有线IP网络(如Ethernet的MTU大小为1500字节)，和基于IP或非IP的无线网MTU254字节或者更小。为了防止两个网络之间的转换，和提前避免不希望的组包大小，NAL单元的聚合组包方案就被设计出来了。<br/>
&emsp;&emsp;主要又两种聚合报文定义:
* Single-time aggregation packets(STAP): 聚合报文内的NAL单元时间戳都一直。定义了两种STAP报文: 非DON(STAP-A)和DON(STAP-B).
* Multi-time aggregation packet(MTAP): 聚合NAL单元的时间戳可以不一致。两种MTAP报文被定义。

***题外话: 这里只翻译STAP-A，原因还是STAB-B和MTAP当前没有应用场景。*** <br/>
&emsp;&emsp;聚合报文的RTP负载格式如Figure3所示:<br/>
![aggregation_rtp_packet](https://github.com/runner365/read_book/blob/master/RTP_H264/pic/Aggregation_RTP_packet.png)<br/>
&emsp;&emsp;MTAPs和STAPs分享下面的组包方式:
* RTP时间戳必须设置成包内所有NAL单元最早的时间戳
* NAL单元类型值必须设置成正确的值，如Table4
* 如果所有的聚合NAL单元都是需要设置F标志位为0，F标志位必须为0；否则为1
* NRI的值应该是NAL单元中最大的值
